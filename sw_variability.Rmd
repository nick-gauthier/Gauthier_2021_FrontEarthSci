---
title: "Southwest Climate Variability"
author: "Nicolas Gauthier"
date: Sys.Date()
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message = F}
library(magrittr)
library(stringr)
library(raster)
library(SPEI)
library(spacetime)
library(zoo)
library(rasterVis)
```



```{r bbox}
bbox <- extent(-115.3997, -102.4102, 31.06377, 37.28437)
```



```{r import, cache = T}
prec <- brick('Data/b40.lm850-1850.1deg.001.cam2.h0.PRECT.085001-185012.nc') %>% 
  extract2(3901:6900) %>% 
  rotate %>%
  crop(bbox) %>%
  multiply_by(3.154e+10)

trefmnav <- brick('Data/b40.lm850-1850.1deg.001.cam2.h0.TREFMNAV.085001-185012.nc') %>%
  extract2(3901:6900) %>%
  rotate %>%
  crop(bbox) %>%
  subtract(273.15)
  
trefmxav <- brick('Data/b40.lm850-1850.1deg.001.cam2.h0.TREFMXAV.085001-185012.nc') %>%
  extract2(3901:6900) %>%
  rotate %>%
  crop(bbox) %>%
  subtract(273.15)
```

```{r times}
times <- prec %>% 
  names %>% 
  str_sub(2) %>% 
  str_replace_all('\\.','-') %>% 
  as.yearmon # use \\ to escape period
```

```{r lats}
lats <- prec[[1]] %>%
  coordinates %>%
  magrittr::extract( , 2)
```

SPEI
```{r }
prcp.val <- getValues(prec) %>% t   # need to transpose, getValues has rows for space and columns for time, hargreaves wants columns for space and rows for time
tmin.val <- getValues(trefmnav) %>% t
tmax.val <- getValues(trefmxav) %>% t
```


```{r}
pet <- hargreaves(tmin.val, tmax.val, lat = lats) %>% as.data.frame#as.matrix#, Pre = prcp.val) %>% as.matrix# using one latitude for now
pet.map <- setValues(prec, t(pet))
levelplot(pet.map[[1]], margin = F)


water.stress <- prcp.val - pet

ws.map <- setValues(prec, t(water.stress))
spei.test <- spei(water.stress, scale = 12)
spei.rast <- setValues(prec, t(spei.test$fitted))

levelplot(spei.rast[[268]], margin = F, par.settings = RdBuTheme())
```

```{r}
stfdf <- spei.rast[[13:3000]] %>% setZ(times[13:3000]) %>% as('STFDF')
```


```{r message = F}
## attempt to compute EOFs
#eof_time <- eof(stfdf, 'temporal')
eof_space <- eof(stfdf, 'spatial') %>% brick
eof(stfdf, 'spatial', returnEOFs = F) %>% screeplot()
```

```{r}
levelplot(eof_space[[1:6]] %>% disaggregate(fact = 100, method = 'bilinear'), par.settings = RdBuTheme())
```

Now do it for each of the five periods.

```{r message = F}
eof.1200 <- spei.rast %>% setZ(times) %>% extract2(1:600) %>% as('STFDF') %>% eof('spatial') %>% brick %>% extract2(1:6) %>% disaggregate(fact = 100, method = 'bilinear') %T>% levelplot(par.settings = RdBuTheme())
```
```{r warning=F}
eof.1250 <- spei.rast %>% setZ(times) %>% extract2(601:1200) %>% as('STFDF') %>% eof('spatial') %>% brick %>% extract2(1:6) %>% disaggregate(fact = 100, method = 'bilinear') %T>% levelplot(par.settings = RdBuTheme())
```

```{r warning=F}
eof.1300 <- spei.rast %>% setZ(times) %>% extract2(1201:1800) %>% as('STFDF') %>% eof('spatial') %>% brick %>% extract2(1:6) %>% disaggregate(fact = 100, method = 'bilinear') %T>% levelplot(par.settings = RdBuTheme())
```

```{r warning=F}
eof.1350 <- spei.rast %>% setZ(times) %>% extract2(1801:2400) %>% as('STFDF') %>% eof('spatial') %>% brick %>% extract2(1:6) %>% disaggregate(fact = 100, method = 'bilinear') %T>% levelplot(par.settings = RdBuTheme())
```

```{r warning=F}
eof.1400 <- spei.rast %>% setZ(times) %>% extract2(2401:3000) %>% as('STFDF') %>% eof('spatial') %>% brick %>% extract2(1:6) %>% disaggregate(fact = 100, method = 'bilinear') %T>% levelplot(par.settings = RdBuTheme())
```
      
      
      
```{r}
writeRaster(eof.1200, 'eof1200.nc')
writeRaster(eof.1250, 'eof1250.nc')
writeRaster(eof.1300, 'eof1300.nc')
writeRaster(eof.1350, 'eof1350.nc')
writeRaster(eof.1400, 'eof1400.nc')

```
