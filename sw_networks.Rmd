---
title: "sw_networks"
author: "Nick Gauthier"
date: "June 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup
Load the necessary packages.
```{r message = F}
library(raster)
library(fields)
library(tidyverse)
library(rgdal)
library(gdistance)
library(wql)
library(tidygraph)
library(ggraph)
library(mgcv)
```

## Data import and preprocessing
Import the node and edge datasets.
```{r message = F}
node_data <- read_csv('Data/attributes_orig.csv')
```

```{r}
swsn <- list.files('Data/Sim', full.names = T) %>%
  map(read.csv, row.names = 1, check.names = F) %>%
  map(as.matrix) %>%
  map(~replace(.x, .x==0, 999)) %>%
  map(as_tbl_graph) %>%
  map(activate, edges) %>%
  imap(~mutate(.x, time = .y)) %>%
  reduce(graph_join) %>%
  filter(!edge_is_loop()) %>%
  mutate(weight = if_else(weight == 999, 0, weight)) %>%
  rename(similarity = weight) %N>%
  left_join(node_data, by = c('name' = 'SWSN_Site'))
```

Create a separate spatial points object, storing the locations of the sites. Convert the coordinates from utm to lat lon, and add back to the original data
```{r}
pts <- swsn %>% 
  select(x = EASTING, y = NORTHING) %>%
  as_tibble %>%
  SpatialPoints(proj4string=CRS("+proj=utm +zone=12 +datum=NAD27")) %>%
  spTransform(CRS("+proj=longlat +datum=WGS84")) %>% 
  coordinates %>%
  data.frame

swsn <- swsn %>%
  mutate(lon = pts$x, 
         lat = pts$y) %E>%
  mutate(from_x = .N()$lon[from],
         from_y = .N()$lat[from],
         to_x = .N()$lon[to],
         to_y = .N()$lat[to],
         size_from = case_when(time == 1 ~ .N()$P1room[from],
                               time == 2 ~ .N()$P2room[from],
                               time == 3 ~ .N()$P3room[from],
                               time == 4 ~ .N()$P4room[from],
                               time == 5 ~ .N()$P5room[from]),
         size_to = case_when(time == 1 ~ .N()$P1room[to],
                             time == 2 ~ .N()$P2room[to],
                             time == 3 ~ .N()$P3room[to],
                             time == 4 ~ .N()$P4room[to],
                             time == 5 ~ .N()$P5room[to]))
```
Get state outlines.
```{r}
states <- maps::map('state', regions = c('arizona', 'new mexico'), fill = T, plot = F)
```

```{r echo = F}
swsn %E>%
  filter(similarity > .75) %>%
ggraph('manual', node.positions = pts) +
  geom_edge_link(aes(alpha = similarity, color = similarity)) +
  facet_edges(~time) +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  scale_edge_alpha() +
  coord_equal() +
  theme_graph()
```

## Least Cost Distances
```{r}
bbox <- extent(c(-113.5, -106.5, 31, 37.5))
elev <- raster('~/Downloads/SRTM_W_250m_TIF/SRTM_W_250m.tif') %>%
  crop(bbox)
```

```{r cache = T}
altDiff <- function(x){x[2] - x[1]}
hd <- transition(elev, altDiff, 8, symm = F)
cell.targets <- Which(!is.na(elev), cells = T)
adj <- adjacent(elev, cells = cell.targets, target = cell.targets, pairs = T, directions = 8)
slope <- geoCorrection(hd, type = 'c')
speed <- slope
speed[adj] <- 6 * exp(-3.5 * abs(slope[adj] + 0.05))
conductance <- geoCorrection(speed, type = 'c')
```

```{r echo = F, message = F, warning = F}
rm(hd, adj, slope, speed)
gc()
```

```{r echo = F}
plot(raster(conductance))
```

Calculate the least cost distance matrix between all sites and turn into a graph.
```{r cache = T}
distances <- swsn %N>%
  select(lon, lat) %>%
  as_tibble %>%
  as.matrix %>%
  costDistance(conductance, .) %>%
  as_tbl_graph %E>%
  rename(distance = weight) %>%
  as_tibble
```

```{r}
bbox_extended <- extent(c(-124, -105, 31, 41))
```

## Empiricial Orthogonal Functions

```{r}
tpsInterp <- function(rast.brick, r){
  target <- raster(crs = '+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 ', 
                   ext = bbox_extended, resolution = r, vals = 1)
  
  brick_data <- as.data.frame(rast.brick, xy = T)
  
  map(1:nlayers(rast.brick), ~interpolate(target, Tps(brick_data[1:2], brick_data[2 + .x], lon.lat = T))) %>% unlist %>% brick
}

```

Compare the coarse resolution rasters, as a bias correction step.
```{r}
da_coarse <- brick('~/Downloads/da_hydro_JunAug_r.1-2000_d.05-Jan-2018.nc', varname = 'spei_mn') %>%
   .[[1900:1999]] %>%
   rotate %>%
   crop(bbox_extended, snap = 'out')
spei_coarse <- ((brick('~/Downloads/spei12_6_PRISM.nc') + 
              brick('~/Downloads/spei12_7_PRISM.nc') + 
              brick('~/Downloads/spei12_8_PRISM.nc')) / 3) %>%
  `names<-`(1895:2017) %>%
  .[[6:105]] %>%
 resample(da_coarse) %>%
  mask(da_coarse)

plot(brick(c(da_coarse[[1:10]], spei_coarse[[1:10]])))
```

```{r}
spei_coarse %>%
  as.data.frame(na.rm = T) %>%
  t %>%
  eofNum(scale. = F)

da_coarse %>%
  as.data.frame(na.rm = T) %>%
  t %>%
  eofNum(scale. = F)
```

```{r}
brick(c(spei_coarse, da_coarse)) %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  gather(year, value, 3:202) %>%
  separate(year, c('year', 'type')) %>%
  mutate(year = str_sub(year, 2),
         year = as.numeric(year),
         type = if_else(type == '1', 'observed', 'data assimilation')) %>%
  ggplot(aes(year, value)) +
  geom_line(alpha = .3, aes(group = interaction(x, y, type), color = type)) +
  geom_smooth(aes(color = type)) +
  ggtitle('Standardized Precipitation-Evapotranspiration Index in the American Southwest',
          'June-August, 12 month lag') +
  theme_bw()
```

The leading 4 eofs are roughly equivalent
```{r}

obs_eof <- eof(t(as.data.frame(spei_coarse, na.rm = T)), 4, scale. = F)
as.data.frame(spei_coarse[[1]], xy = T, na.rm = T) %>%cbind(obs_eof$REOF) %>%
  select(-3) %>%
  gather(eof, value, 3:6) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = value)) +
    scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1, 1)) +
  facet_wrap(~eof) +
  coord_quickmap()

```
```{r}
da_eof <- eof(t(as.data.frame(da_coarse, na.rm = T)), 4, scale. = F)
as.data.frame(da_coarse[[1]], xy = T, na.rm = T) %>%cbind(da_eof$REOF) %>%
  select(-3) %>%
  gather(eof, value, 3:6) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = value)) +
    scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1, 1)) +
  facet_wrap(~eof) +
  coord_quickmap()
```

Now see about bias correcting the da fields.
```{r}
spei_dat <- left_join(spei_coarse %>%
  as.data.frame(xy = T, na.rm = T) %>%
  gather(year, obs, 3:102) %>%
  mutate(year = as.numeric(str_sub(year, 2))),
da_coarse %>%
  as.data.frame(xy = T, na.rm = T)  %>%
  gather(year, da, 3:102) %>%
  mutate(year = as.numeric(str_sub(year,2)))) %>% 
  mutate(cell = interaction(x, y))

m1 <- gam(obs ~ s(da, bs = 'cr'), data = spei_dat, method = 'REML')
m2 <- gamm(obs ~ s(da, bs = 'cr'), 
           data = spei_dat, method = 'REML', 
           correlation = corAR1(form = ~year|cell))
plot(m1, residuals = T)
plot(m2$gam, scheme = 2)
summary(m1)
summary(m2$gam)
m2
gam.check(m1)
AIC(m1);AIC(m2$gam)
```

```{r}
spei_dat %>%
  mutate(res = residuals(m1)) %>%
  qplot(x, y, fill = res, data = ., geom = 'raster') + 
  scale_fill_distiller(palette = 'RdBu', direction = 1) + 
  facet_wrap(~year) +
  theme_void()
  

spei_dat %>%
  mutate(res = residuals(m1)) %>%
  group_by(year) %>%
  summarise(res = mean(res)) %>% pull(res) %>% acf
```


```{r}
spei_obs <- ((brick('~/Downloads/spei12_6_PRISM.nc') + 
              brick('~/Downloads/spei12_7_PRISM.nc') + 
              brick('~/Downloads/spei12_8_PRISM.nc')) / 3) %>%
  crop(bbox_extended) %>%
  `names<-`(1895:2017) %>%
  .[[6:105]] %>%
  aggregate(fact = 2)

da_obs <- brick('~/Downloads/da_hydro_JunAug_r.1-2000_d.05-Jan-2018.nc', varname = 'spei_mn') %>%
   .[[1950:1999]] %>%
   rotate %>%
   crop(extent(c(-117,-100, 30, 44)), snap = 'out') %>%
   tpsInterp(0.08333333) %>%
   crop(bbox_extended) %>%
   mask(spei_obs) %>%
  resample(spei_obs)

elev <- raster('~/Downloads/SRTM_W_250m_TIF/SRTM_W_250m.tif') %>%
  crop(bbox_extended) %>%
  resample(spei_obs) %>%
  mask(spei_obs[[1]])

brick(c(spei_obs[[1]], da_obs[[1]], elev)) %>% plot
```

```{r}
plot(test$obs, test$da)

t1 <- bam(obs ~ s(da, bs = 'cr'),
          data = test, method = 'REML')

plot(t1, residuals = T)
gam.check(t1)
test %>% mutate(res = residuals(t1)) %>%
  group_by(x, y) %>%
  mutate(res = mean(res)) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = res)) +
  coord_quickmap()


plot(elev)
test %>% mutate(res = residuals(t1)) %>%
  group_by(x, y) %>%
  mutate(res_avg = mean(res)) %>% left_join(as.data.frame(elev, xy = T, na.rm =T)) %>%
  filter(between(year, 1900, 1910)) %>%
   ggplot(aes(x,y)) +
  geom_raster(aes(fill = res)) +
  scale_fill_distiller(palette = 'RdBu', limits = c(-3, 3)) +
  facet_wrap(~year) +
  coord_quickmap()
```

```{r warning = F, message = F}

spei_coarse <- brick('~/Downloads/da_hydro_JunAug_r.1-2000_d.05-Jan-2018.nc', varname = 'spei_mn') %>%
  .[[1100:1499]] %>%
  rotate %>%
  crop(bbox_extended, snap = 'out') 

spei <- spei_coarse %>%
  tpsInterp(.083333333333)
```

```{r echo = F}
spei_coarse %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  `names<-`(c('x', 'y', 1100:1499)) %>%
  gather(year, value, 3:402) %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(year, value)) +
  geom_line(alpha = .1, aes(group = interaction(x, y))) +
  geom_smooth() +
  ggtitle('Standardized Precipitation-Evapotranspiration Index in the American Southwest',
          'June-August, 12 month lag') +
  theme_bw()
```


```{r echo = F}
plot(spei_coarse[[1]])
eofNum(t(as.matrix(spei_coarse)), scale. = F)
eofNum(t(as.matrix(spei_obs)), scale. = F)
t3 <- as.data.frame(spei_obs, na.rm = T) %>% 
  t %>%
  eof(6, scale. = F)

  
rasterVis::levelplot(setValues(spei_obs[[1:6]][!is.na(spei_obs[[1:6]])],t3$REOF))
t1 <- wql::eof(t(as.matrix(spei_coarse)), 4, scale. = F)
setValues(spei_coarse[[1:6]],t1$REOF) %>% plot
```

```{r}
t3 <- wql::eof(t(as.matrix(spei_obs)), 6, scale. = F)
rasterVis::levelplot(setValues(spei[[1:6]],t3$REOF))
rasterVis::levelplot(crop(setValues(spei[[1:6]],t3$REOF), bbox))
setValues(spei_coarse[[1]], xyFromCell(spei_coarse, 1:ncell(spei_coarse))[,2]) %>% cos %>% plot


    eigs <- prcomp(t(as.data.frame(da_obs, na.rm = T)), scale. = F)[["sdev"]]^2
    eigs.pct <- 100 * eigs/sum(eigs)
    eigs.lo <- eigs * (1 - sqrt(2/400))
    eigs.hi <- eigs * (1 + sqrt(2/400))
    cumvar <- round(cumsum(eigs.pct), 1)
    p <- 400
    d <- data.frame(rank = factor(1:p), eigs, eigs.lo, eigs.hi, 
        cumvar)
    d <- within(d, cumvar.line <- eigs.hi + 0.02 * max(eigs.hi))
    d <- d[1:min(p, 10), ]
    ggplot(data = d, aes(x = rank, y = eigs)) + geom_errorbar(aes(x = rank, 
        ymin = eigs.lo, ymax = eigs.hi), width = 0.3) + geom_point(size = 3) + 
        geom_text(aes(x = rank, y = cumvar.line, label = cumvar), 
            size = 3, vjust = 0) + labs(list(x = "Rank", y = "Eigenvalue")) + 
        theme(panel.grid.minor = element_blank())
    
    edit(eof)
```
```{r}

obs_eof <- eof(t(as.data.frame(spei_obs, na.rm = T)), 6, scale. = F)
as.data.frame(spei_obs[[1]], xy = T, na.rm = T) %>%cbind(obs_eof$REOF) %>%
  select(-3) %>%
  gather(eof, value, 3:8) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = value)) +
    scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1, 1)) +
  facet_wrap(~eof) +
  coord_quickmap()

```
```{r}
da_eof <- eof(t(as.data.frame(da_obs, na.rm = T)), 6, scale. = F)
as.data.frame(da_obs[[1]], xy = T, na.rm = T) %>%cbind(da_eof$REOF) %>%
  select(-3) %>%
  gather(eof, value, 3:8) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = value)) +
    scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1, 1)) +
  facet_wrap(~eof) +
  coord_quickmap()
```

```{r}
da_eof <- eof(t(as.data.frame(da_obs, na.rm = T)), 6, scale. = F)
as.data.frame(da_obs[[1]], xy = T, na.rm = T) %>%cbind(da_eof$REOF) %>%
  select(-3) %>%
  gather(eof, value, 3:8) %>%
  ggplot(aes(x,y)) +
  geom_raster(aes(fill = value)) +
    scale_fill_distiller(palette = 'RdBu', direction = 1, limits = c(-1, 1)) +
  facet_wrap(~eof) +
  coord_quickmap()
```

```{r echo = F}
plot(eof_time[,2])
```

```{r echo = F}
plot(eof_diag$sdev[1:10]/sum(eof_diag$sdev))
screeplot(eof_diag, type = 'lines')
biplot(eof_diag, var.axes = F)

test <- as_tibble(eof_diag$rotation)

```


## Model fitting
```{r}
dat <- swsn %E>%
  left_join(distances) %>%
  as_tibble %>%
  mutate(distance = replace_na(distance, 0)) %>%
  mutate(edge = as.factor(paste(from, to, sep = '-')))
```

```{r echo = F}
ggplot(dat, aes(distance, similarity)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  theme_minimal()
dat %>% 
  mutate(group = paste(from, to, sep = '-')) %>%
ggplot(aes(time, similarity, group = group)) +
  geom_line(alpha = .1)
```

```{r}
mod1 <- bam(similarity ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod2 <- bam(similarity ~ s(distance, bs = 'cr') +
                         s(size_from, bs = 'cr') +
                         s(size_to, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod3 <- bam(similarity ~ s(distance, bs = 'cr') +
              s(size_from, bs = 'cr') +
              s(size_to, bs = 'cr') +
            s(from_x, from_y, k = 30) +
            s(to_x, to_y, k = 30),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod3 <- bam(similarity ~ s(distance, bs = 'cr') +
            s(from_x, from_y) +
            s(to_x, to_y),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod2 <- gamm(similarity * 1000 ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = poisson,
            correlation = corAR1(form = ~time|edge),
            data = dat)

plot(mod1);plot(mod2);plot(mod3)
AIC(mod1);AIC(mod2);AIC(mod3)
gam.check(mod3)
```

```{r}
test <- dat %>%
  mutate(resid = residuals(mod1, type = 'response')) %>%
  group_by(from, to) %>%
  arrange(time, .by_group = T) %>%
select(from, to, time, resid) %>%
  mutate(lag1 = lag(resid)) %>%
  filter(!is.na(lag1))
cor(test$resid, test$lag1)

acf(test[1:3,6], lag.max = 5)

mod2 <- dat %>% 
  group_by(from, to) %>% 
  arrange(time, .by_group = T) %>%
  mutate(test = if_else(row_number() == 1, T, F)) %>%
  bam(similarity ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            rho = .3,
            AR.start = test,
            data = .)

plot(mod2)
presidents

swsn %E>% filter(from == 1) %>% as_tibble %>% select(similarity) %>% pull %>% sum
```

```{r}
mod2 <- gam(weight ~ s(distance, bs = 'cr'),
            method = 'REML',
            select = T, 
            data = dat)
mod3 <- gam(weight ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = gaussian(link = 'log'),
            select = T, 
            data = dat)
mod4 <- gam(weight * 1000 ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = poisson,
            select = T, 
            data = dat)
plot(mod1); plot(mod2); plot(mod3); plot(mod4)
list(mod1,mod2,mod3, mod4) %>% map(summary)
list(mod1,mod2,mod3, mod4) %>% map(gam.check)
```

```{r}
mod5 <- gam(weight ~ s(distance, bs = 'cr') +
                     s(size_prod, bs = 'cr') +
                     ti(distance, size_prod), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps  = .0001,
            data = dat)
mod6 <- gam(weight ~ te(distance, size_prod), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps = .0001,
            data = dat)
mod7 <- gam(weight ~ te(distance, size_sum), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps = .0001,
            data = dat)
mod8 <- gam(weight ~ s(distance, bs = 'cr') +
                     s(size_sum, bs = 'cr') +
                     ti(distance, size_sum), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps  = .0001,
            data = dat)

plot(mod5, scheme = 1)
plot(mod6, scheme = 1)
plot(mod7, scheme = 1)
plot(mod8, scheme = 1)
summary(mod5);summary(mod6);summary(mod7)
gam.check(mod6)
dat %>% 
  pull(weight) %>%
  summary
```

```{r}
swsn %E>%
  mutate(resid = residuals(mod2, type = 'response')) %>%
  filter(resid > .25 | resid < -.25) %>%
  mutate(fac = if_else(resid > 0, 'pos', 'neg')) %>%
  ggraph('manual', node.positions = pts) +
  geom_edge_link(aes(alpha = abs(resid), color = resid)) +
  facet_graph(time ~ fac, col_type = 'edge') +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  scale_edge_colour_distiller(palette = 'RdBu', limits = c(-1,1)) +
  coord_equal() +
  theme_graph()
```

