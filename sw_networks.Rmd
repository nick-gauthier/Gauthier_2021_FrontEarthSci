---
title: "sw_networks"
author: "Nick Gauthier"
date: "June 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup
Load the necessary packages.
```{r message = F}
library(raster)
library(fields)
library(tidyverse)
library(rgdal)
library(gdistance)
library(wql)
library(tidygraph)
library(ggraph)
library(mgcv)
```

## Data import and preprocessing
Import the node and edge datasets.
```{r message = F}
node_data <- read_csv('Data/attributes_orig.csv')
```

```{r}
swsn <- list.files('Data/Sim', full.names = T) %>%
  map(read.csv, row.names = 1, check.names = F) %>%
  map(as.matrix) %>%
  map(~replace(.x, .x==0, 999)) %>%
  map(as_tbl_graph) %>%
  map(activate, edges) %>%
  imap(~mutate(.x, time = .y)) %>%
  reduce(graph_join) %>%
  filter(!edge_is_loop()) %>%
  mutate(weight = if_else(weight == 999, 0, weight)) %>%
  rename(similarity = weight) %N>%
  left_join(node_data, by = c('name' = 'SWSN_Site'))
```

Create a separate spatial points object, storing the locations of the sites. Convert the coordinates from utm to lat lon, and add back to the original data
```{r}
pts <- swsn %>% 
  select(x = EASTING, y = NORTHING) %>%
  as_tibble %>%
  SpatialPoints(proj4string=CRS("+proj=utm +zone=12 +datum=NAD27")) %>%
  spTransform(CRS("+proj=longlat +datum=WGS84")) %>% 
  coordinates %>%
  data.frame

swsn <- swsn %>%
  mutate(lon = pts$x, 
         lat = pts$y) %E>%
  mutate(from_x = .N()$lon[from],
         from_y = .N()$lat[from],
         to_x = .N()$lon[to],
         to_y = .N()$lat[to],
         size_from = case_when(time == 1 ~ .N()$P1room[from],
                               time == 2 ~ .N()$P2room[from],
                               time == 3 ~ .N()$P3room[from],
                               time == 4 ~ .N()$P4room[from],
                               time == 5 ~ .N()$P5room[from]),
         size_to = case_when(time == 1 ~ .N()$P1room[to],
                             time == 2 ~ .N()$P2room[to],
                             time == 3 ~ .N()$P3room[to],
                             time == 4 ~ .N()$P4room[to],
                             time == 5 ~ .N()$P5room[to]))
```
Get state outlines.
```{r}
states <- maps::map('state', regions = c('arizona', 'new mexico'), fill = T, plot = F)
```

```{r echo = F}
swsn %E>%
  filter(similarity > .75) %>%
ggraph('manual', node.positions = pts) +
  geom_edge_link(aes(alpha = similarity, color = similarity)) +
  facet_edges(~time) +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  scale_edge_alpha() +
  coord_equal() +
  theme_graph()
```

## Least Cost Distances
```{r}
bbox <- extent(c(-113.5, -106.5, 31, 37.5))
elev <- raster('~/Downloads/SRTM_W_250m_TIF/SRTM_W_250m.tif') %>%
  crop(bbox)
```

```{r cache = T}
altDiff <- function(x){x[2] - x[1]}
hd <- transition(elev, altDiff, 8, symm = F)
cell.targets <- Which(!is.na(elev), cells = T)
adj <- adjacent(elev, cells = cell.targets, target = cell.targets, pairs = T, directions = 8)
slope <- geoCorrection(hd, type = 'c')
speed <- slope
speed[adj] <- 6 * exp(-3.5 * abs(slope[adj] + 0.05))
conductance <- geoCorrection(speed, type = 'c')
```

```{r echo = F, message = F, warning = F}
rm(hd, adj, slope, speed)
gc()
```

```{r echo = F}
plot(raster(conductance))
```

Calculate the least cost distance matrix between all sites and turn into a graph.
```{r cache = T}
distances <- swsn %N>%
  select(lon, lat) %>%
  as_tibble %>%
  as.matrix %>%
  costDistance(conductance, .) %>%
  as_tbl_graph %E>%
  rename(distance = weight) %>%
  as_tibble
```

## Empiricial Orthogonal Functions

```{r}
tpsInterp <- function(rast.brick, r){
  target <- raster(crs = '+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 ', 
                   ext = bbox_extended, resolution = r, vals = 1)
  
  brick_data <- as.data.frame(rast.brick, xy = T)
  
  map(1:nlayers(rast.brick), ~interpolate(target, Tps(brick_data[1:2], brick_data[2 + .x], lon.lat = T))) %>% unlist %>% brick
}
```
```{r}
spei_obs <- ((brick('~/Downloads/spei12_6_PRISM.nc') + 
              brick('~/Downloads/spei12_7_PRISM.nc') + 
              brick('~/Downloads/spei12_8_PRISM.nc')) / 3) %>%
  crop(bbox_extended) %>%
  `names<-`(1895:2017) %>%
  .[[6:105]]

da_obs <- brick('~/Downloads/da_hydro_JunAug_r.1-2000_d.05-Jan-2018.nc', varname = 'spei_mn') %>%
   .[[1900:1999]] %>%
   rotate %>%
   crop(bbox_extended, snap = 'out') %>%
   resample(spei_obs) %>%
  crop(bbox_extended) %>%
  mask(spei_obs)
plot(spei_obs, da_obs)

spei_obs %>%
  as.data.frame(xy = T, na.rm = T) %>%
  gather(year, value, 3:102) %>%
  mutate(year = as.numeric(str_sub(year, 2))) %>%
  ggplot(aes(year, value)) +
    geom_line(apha = .1, aes(group = intersect(x,y)))
```

```{r warning = F, message = F}
bbox_extended <- extent(c(-120, -103, 29, 45))

spei_coarse <- brick('~/Downloads/da_hydro_JunAug_r.1-2000_d.05-Jan-2018.nc', varname = 'spei_mn') %>%
  .[[1100:1499]] %>%
  rotate %>%
  crop(bbox_extended, snap = 'out') 

spei <- spei_coarse %>%
  tpsInterp(.083333333333)
```

```{r echo = F}
spei_coarse %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  `names<-`(c('x', 'y', 1100:1499)) %>%
  gather(year, value, 3:402) %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(year, value)) +
  geom_line(alpha = .1, aes(group = interaction(x, y))) +
  geom_smooth() +
  ggtitle('Standardized Precipitation-Evapotranspiration Index in the American Southwest',
          'June-August, 12 month lag') +
  theme_bw()
```




```{r message = F}
eof_space_detrend <- eof(stfdf, 'spatial') %>% brick
eof_time <- eof(stfdf, 'temporal')
eof_diag_space <- eof(stfdf, 'spatial', returnEOFs = F)
eof_diag_time <- eof(stfdf, 'temporal', returnEOFs = F)
```

```{r echo = F}
plot(spei_coarse[[1]])
eofNum(t(as.matrix(spei_coarse)), scale. = F)
eofNum(t(as.matrix(spei_obs)), scale. = F)
as.data.frame(spei_obs, na.rm = T) %>% 
  t %>%
  eofNum(scale. = F)
t1 <- wql::eof(t(as.matrix(spei_coarse)), 4, scale. = F)
setValues(spei_coarse[[1:6]],t1$REOF) %>% plot
```

```{r}
t3 <- wql::eof(t(as.matrix(spei)), 6, scale. = F)
rasterVis::levelplot(setValues(spei[[1:6]],t3$REOF))
rasterVis::levelplot(crop(setValues(spei[[1:6]],t3$REOF), bbox))
setValues(spei_coarse[[1]], xyFromCell(spei_coarse, 1:ncell(spei_coarse))[,2]) %>% cos %>% plot


edit(eof)
```

{r echo = F}
plot(eof_time[,2])
```

```{r echo = F}
plot(eof_diag$sdev[1:10]/sum(eof_diag$sdev))
screeplot(eof_diag, type = 'lines')
biplot(eof_diag, var.axes = F)

test <- as_tibble(eof_diag$rotation)

```


## Model fitting
```{r}
dat <- swsn %E>%
  left_join(distances) %>%
  as_tibble %>%
  mutate(distance = replace_na(distance, 0)) %>%
  mutate(edge = as.factor(paste(from, to, sep = '-')))
```

```{r echo = F}
ggplot(dat, aes(distance, similarity)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  theme_minimal()
dat %>% 
  mutate(group = paste(from, to, sep = '-')) %>%
ggplot(aes(time, similarity, group = group)) +
  geom_line(alpha = .1)
```

```{r}
mod1 <- bam(similarity ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod2 <- bam(similarity ~ s(distance, bs = 'cr') +
                         s(size_from, bs = 'cr') +
                         s(size_to, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod3 <- bam(similarity ~ s(distance, bs = 'cr') +
              s(size_from, bs = 'cr') +
              s(size_to, bs = 'cr') +
            s(from_x, from_y, k = 30) +
            s(to_x, to_y, k = 30),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod3 <- bam(similarity ~ s(distance, bs = 'cr') +
            s(from_x, from_y) +
            s(to_x, to_y),
            method = 'REML',
            family = betar(link = 'cloglog'),
            data = dat)

mod2 <- gamm(similarity * 1000 ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = poisson,
            correlation = corAR1(form = ~time|edge),
            data = dat)

plot(mod1);plot(mod2);plot(mod3)
AIC(mod1);AIC(mod2);AIC(mod3)
gam.check(mod3)
```

```{r}
test <- dat %>%
  mutate(resid = residuals(mod1, type = 'response')) %>%
  group_by(from, to) %>%
  arrange(time, .by_group = T) %>%
select(from, to, time, resid) %>%
  mutate(lag1 = lag(resid)) %>%
  filter(!is.na(lag1))
cor(test$resid, test$lag1)

acf(test[1:3,6], lag.max = 5)

mod2 <- dat %>% 
  group_by(from, to) %>% 
  arrange(time, .by_group = T) %>%
  mutate(test = if_else(row_number() == 1, T, F)) %>%
  bam(similarity ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = betar(link = 'cloglog'),
            rho = .3,
            AR.start = test,
            data = .)

plot(mod2)
presidents

swsn %E>% filter(from == 1) %>% as_tibble %>% select(similarity) %>% pull %>% sum
```

```{r}
mod2 <- gam(weight ~ s(distance, bs = 'cr'),
            method = 'REML',
            select = T, 
            data = dat)
mod3 <- gam(weight ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = gaussian(link = 'log'),
            select = T, 
            data = dat)
mod4 <- gam(weight * 1000 ~ s(distance, bs = 'cr'),
            method = 'REML',
            family = poisson,
            select = T, 
            data = dat)
plot(mod1); plot(mod2); plot(mod3); plot(mod4)
list(mod1,mod2,mod3, mod4) %>% map(summary)
list(mod1,mod2,mod3, mod4) %>% map(gam.check)
```

```{r}
mod5 <- gam(weight ~ s(distance, bs = 'cr') +
                     s(size_prod, bs = 'cr') +
                     ti(distance, size_prod), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps  = .0001,
            data = dat)
mod6 <- gam(weight ~ te(distance, size_prod), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps = .0001,
            data = dat)
mod7 <- gam(weight ~ te(distance, size_sum), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps = .0001,
            data = dat)
mod8 <- gam(weight ~ s(distance, bs = 'cr') +
                     s(size_sum, bs = 'cr') +
                     ti(distance, size_sum), 
            method = 'REML',
            select = T, 
            family = betar(link = 'cloglog'),
            eps  = .0001,
            data = dat)

plot(mod5, scheme = 1)
plot(mod6, scheme = 1)
plot(mod7, scheme = 1)
plot(mod8, scheme = 1)
summary(mod5);summary(mod6);summary(mod7)
gam.check(mod6)
dat %>% 
  pull(weight) %>%
  summary
```

```{r}
swsn %E>%
  mutate(resid = residuals(mod2, type = 'response')) %>%
  filter(resid > .25 | resid < -.25) %>%
  mutate(fac = if_else(resid > 0, 'pos', 'neg')) %>%
  ggraph('manual', node.positions = pts) +
  geom_edge_link(aes(alpha = abs(resid), color = resid)) +
  facet_graph(time ~ fac, col_type = 'edge') +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  scale_edge_colour_distiller(palette = 'RdBu', limits = c(-1,1)) +
  coord_equal() +
  theme_graph()
```

