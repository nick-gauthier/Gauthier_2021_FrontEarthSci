---
title: "Southwest Social Networks"
author: "Nick Gauthier"
output:
  pdf_document: 
    keep_tex: yes
  html_document: 
    fig_height: 10
    fig_width: 10
    keep_md: yes
---
# Data import

First import the SWSN attribute file. Use tidyverse packages for data munging.

Site coordinates are in UTM, so first use rgdal to reproject to LatLon.
```{r message = F, warning = F}
library(tidyverse)
library(rgdal)
library(igraph)
library(ggraph)
library(maps)
library(maptools)
library(raster)
library(rasterVis)
```

Import the SWSN attribute file and reproject the UTM coordinates to Lat-Lon.
```{r}
swsn.attr <- read_csv('Data/attributes_orig.csv') %>%
  select(-1) # drop ID column

swsn.pts <-  swsn.attr %>% 
  select(x = EASTING, y = NORTHING) %>%
  SpatialPoints(proj4string=CRS("+proj=utm +zone=12 +datum=WGS84")) %>%
  spTransform(CRS("+proj=longlat +datum=WGS84")) %>% 
  coordinates %>%
  data.frame
```


Now define a function to import the SWSN adjacency matrix for a given time step. This function imports the adjacency matrix, keeps only those connections with >= 75% similarity, and creates an igraph object. Then it adds attribute data from above to the graph object.
```{r message = F}
readSWSN <- function(net){
  read.csv(net, row.names = 1, check.names = F)  %>%
    as.matrix %>%
    graph_from_adjacency_matrix(mode = 'undirected', weighted = T, diag = F) %>%
    as_data_frame %>%
    graph_from_data_frame(directed = F, vertices = swsn.attr)
}
```

Use the function to import the network datasets.
```{r}
ad1200 <- readSWSN('Data/AD1200sim.csv')
```

## some network plots

```{r}
ad1200 %>% 
  delete_edges(E(ad1200)[E(ad1200)$weight < .75]) %>%
  ggraph('manual', node.positions = swsn.pts) +
  geom_edge_link(aes(alpha = weight, color = weight)) +
  geom_node_point(aes(size = P1room)) +
  scale_size_area() +
  scale_edge_color_viridis() +
  scale_edge_alpha() +
  coord_quickmap()+
  theme_void()
```

```{r}
states <- map('state', regions = c('arizona', 'new mexico'), fill = T, plot = F)
IDs <- sapply(strsplit(states$names, ":"), function(x) x[1])
states.ply <- map2SpatialPolygons(states, IDs=IDs)
```

```{r}
test.plot <- ad1200 %>% 
  delete_edges(E(ad1200)[E(ad1200)$weight < .75]) %>%
  ggraph('manual', node.positions = swsn.pts) +
  geom_polygon(aes(x = long, y = lat, group = region), data = states, color = 'black', fill = 'white') +
  geom_edge_link(aes(alpha = weight, color = weight)) +
  geom_node_point(aes(size = P1room)) +
  scale_size_area() +
  scale_edge_color_viridis() +
  scale_edge_alpha() +
  geom_label(x = -106, y = 35, label = 'AD 1200') +
  coord_quickmap() +
  theme_void()

test.plot
```

Now try adding the EOF
```{r}
eof1200 <- brick('Data/eof1200.nc')[[3]] %>% mask(states.ply)
eof.dat <- data_frame(x = init(eof1200, 'x') %>% mask(states.ply)%>% getValues,
                      y = init(eof1200, 'y') %>% %>% mask(states.ply)getValues,
                      z = getValues(eof1200))

test.plot + geom_raster(aes(x = x, y = y, fill = z), data = eof.dat, na.rm = T, show.legend = F)
```



## More Minimal network maps

```{r}
library(GGally)
library(ggmap)
library(raster)


plotEOF <- function(x){
  mask(x, states.ply) %>%
  rasterVis::gplot +
  geom_raster(aes(fill = value), na.rm = T, show.legend = F) +
  scale_fill_distiller(palette = 'RdBu', na.value = NA) +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  coord_quickmap() +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude")
}

```

