---
title: "Southwest Social Networks"
author: "Nick Gauthier"
output:
  pdf_document: 
    keep_tex: yes
  html_document: 
    fig_height: 10
    fig_width: 10
    keep_md: yes
---
# Data import

First import the SWSN attribute file. Use tidyverse packages for data munging.

Site coordinates are in UTM, so first use rgdal to reproject to LatLon.
```{r message = F, warning = F}
library(tidyverse)
library(rgdal)
library(igraph)
library(ggraph)
```

Import the SWSN attribute file and reproject the UTM coordinates to Lat-Lon.
```{r}
swsn.attr <- read_csv('Data/attributes_orig.csv') %>%
  select(-1) # drop ID column

swsn.attr <-  swsn.attr %>% 
  select(x = EASTING, y = NORTHING) %>%
  SpatialPoints(proj4string=CRS("+proj=utm +zone=12 +datum=WGS84")) %>%
  spTransform(CRS("+proj=longlat +datum=WGS84")) %>% 
  coordinates %>%
  data.frame %>%
  cbind(swsn.attr, .)

glimpse(swsn.attr)
```


Now define a function to import the SWSN adjacency matrix for a given time step. This function imports the adjacency matrix, keeps only those connections with >= 75% similarity, and creates an igraph object. Then it adds attribute data from above to the graph object.
```{r message = F}
  # we use a hack here to set the vertex attributes. need to find if there's another way to easily add a whole dataframe of vertex attributes using something other than graph_from_data_frame's vertices arguement
readSWSN <- function(net){
  read.csv(net, row.names = 1, check.names = F)  %>%
    as.matrix %>%
    graph_from_adjacency_matrix(mode = 'undirected', weighted = T, diag = F) %>%
    as_data_frame %>%
    graph_from_data_frame(directed = F, vertices = swsn.attr)
}
```

Use the function to import the network datasets.
```{r}
ad1200 <- readSWSN('Data/AD1200sim.csv')
ad1250 <- readSWSN('Data/AD1250sim.csv')
ad1300 <- readSWSN('Data/AD1300sim.csv')
ad1350 <- readSWSN('Data/AD1350sim.csv')
ad1400 <- readSWSN('Data/AD1400sim.csv')
```

## some network plots

```{r}
ggraph(ad1200, 'manual', node.positions = swsn.attr) +
  geom_edge_link(aes(alpha = weight, color = weight)) +
  geom_node_point() +
  scale_edge_color_viridis() +
  coord_fixed()+
  theme_void()
```



## More Minimal network maps

```{r}
library(GGally)
library(ggmap)
library(maps)
library(raster)
library(maptools)

states <- map('state', regions = c('arizona', 'new mexico'), fill = T, plot = F)
IDs <- sapply(strsplit(states$names, ":"), function(x) x[1])
states.ply <- map2SpatialPolygons(states, IDs=IDs)


plotBase <- ggplot(data = states) +
  geom_polygon(aes(x = long, y = lat, group = region), color = 'black', fill = 'white') +
  coord_quickmap() +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude")

n1 <- ggnetworkmap(plotBase, ad1200, great.circles = T, size = .5, segment.alpha = I(.5)) +
  geom_label(x = -106, y = 35, label = 'AD 1200')

n2 <- ggnetworkmap(plotBase, ad1250, great.circles = T, size = .5, segment.alpha = I(.5)) +
  geom_label(x = -106, y = 35, label = 'AD 1250')

n3 <- ggnetworkmap(plotBase, ad1300, great.circles = T, size = .5, segment.alpha = I(.5)) +
  geom_label(x = -106, y = 35, label = 'AD 1300')

n4 <- ggnetworkmap(plotBase, ad1350, great.circles = T, size = .5, segment.alpha = I(.5)) +
  geom_label(x = -106, y = 35, label = 'AD 1350')

n5 <- ggnetworkmap(plotBase, ad1400, great.circles = T, size = .5, segment.alpha = I(.5)) +
  geom_label(x = -106, y = 35, label = 'AD 1400')


plotEOF <- function(x){
  mask(x, states.ply) %>%
  rasterVis::gplot +
  geom_raster(aes(fill = value), na.rm = T, show.legend = F) +
  scale_fill_distiller(palette = 'RdBu', na.value = NA) +
  geom_polygon(data = states, aes(x = long, y = lat, group = region), color = 'black', fill = NA) +
  coord_quickmap() +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude")
}

eof1200 <- brick('Data/eof1200.nc')[[3]] %>% plotEOF
eof1250 <- brick('Data/eof1250.nc')[[3]] %>% plotEOF
eof1300 <- brick('Data/eof1300.nc')[[3]] %>% plotEOF
eof1350 <- brick('Data/eof1350.nc')[[3]] %>% plotEOF
eof1400 <- brick('Data/eof1400.nc')[[3]] %>% plotEOF

e1 <- ggnetworkmap(eof1200, ad1200, great.circles = T, size = .5, segment.alpha = I(.5)) #+ geom_label(x = -106, y = 35, label = 'AD 1200')
e2 <- ggnetworkmap(eof1250, ad1250, great.circles = T, size = .5, segment.alpha = I(.5)) #+ geom_label(x = -106, y = 35, label = 'AD 1250')
e3 <- ggnetworkmap(eof1300, ad1300, great.circles = T, size = .5, segment.alpha = I(.5)) #+ geom_label(x = -106, y = 35, label = 'AD 1300')
e4 <- ggnetworkmap(eof1350, ad1350, great.circles = T, size = .5, segment.alpha = I(.5)) #+ geom_label(x = -106, y = 35, label = 'AD 1350')
e5 <- ggnetworkmap(eof1400, ad1400, great.circles = T, size = .5, segment.alpha = I(.5)) #+ geom_label(x = -106, y = 35, label = 'AD 1400')
```

```{r, include=FALSE}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  if (is.null(layout)) {
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    for (i in 1:numPlots) {
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r}
multiplot(n1, n2, n3, n4, layout = matrix(c(1,2,3,4), byrow = T, nrow = 2))
multiplot(e1, e2, e3, e4, layout = matrix(c(1,2,3,4), byrow = T, nrow = 2))

#multiplot(n1, n2, n3, n4, n5, layout = matrix(c(1,2,3,4,5,6), byrow = T, nrow = 3))
#multiplot(e1, e2, e3, e4, e5, layout = matrix(c(1,2,3,4,5,6), byrow = T, nrow = 3))

```
